<!DOCTYPE html>
<head>
  <style>

  form {
    font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  }

  svg {
    font: 10px sans-serif;
  }

  </style>
</head>

<body>

  <div class="container">
    <div id="slider"></div>
    <div id="chart">
      <svg width="960" height="570"></svg>
    </div>
  </div>

  <script type="text/javascript" src="d3.js"></script>
  <script>
  var svg = d3.select("svg"),
      headline = "Number of H1-B Certifications in",
      width = +svg.attr("width"),
      height = +svg.attr("height");

  var company_size = function(color) { return d3.interpolateRgb(color, "#fff")(0.2); },
      color = d3.scaleOrdinal(d3.schemeCategory20.map(company_size)),
      format = d3.format(",d");

  var treemap = d3.treemap()
      .tile(d3.treemapResquarify)
      .size([width/1.5, height])
      .round(true)
      .paddingInner(1);

  d3.select("#slider").insert("p", ":first-child").append("input")
      .attr("type", "range")
      .attr("min", "2011")
      .attr("max", "2016")
      .attr("value", 2011)
      .attr("id", "sliderControl");

  d3.select("#slider").insert("h2", ":first-child").text(headline + " " + 2011);

  // Reading Data
  d3.json("company_size.json", function(error, data) {
    if (error) throw error;

    // Initialize data
    var root = d3.hierarchy(data[0])
        .eachBefore(function(d) { d.data.id = (d.parent ? d.parent.data.id + "." : "") + d.data.name;})
        .sum(function(d){return d.size})
        .sort(function(a, b) { return b.height - a.height || a.value - b.value; });

    // Make treemap object and call the make treemap function 
    treemap(root);
    // makeTreemap(root);

    // On Select
    d3.select("#sliderControl").on("input", function() {
      var index = this.value - 2011;
      var currentData = data[index];

      document.querySelector("#slider h2").innerHTML = headline + " " + this.value;

      newRoots = d3.hierarchy(currentData)
        .eachBefore(function(d) { d.data.id = (d.parent ? d.parent.data.id + "." : "") + d.data.name; })
        .sum(function(d){return d.size})
        .sort(function(a, b) { return b.height - a.height || a.value - b.value; });

      changed(newRoots);
    });


    // FUNCTIONS
    // Builder Function
    // function makeTreemap(rt) {
    var cell = svg.selectAll("g")
      .data(root.leaves())
      .enter().append("g")
      .attr("transform", function(d) { return "translate(" + d.x0 + "," + d.y0 + ")"; });

    cell.append("rect")
        .attr("id", function(d) { return d.data.id; })
        .attr("width", function(d) { return d.x1 - d.x0; })
        .attr("height", function(d) { return d.y1 - d.y0; })
        .attr("fill", function(d) { return color(d.parent.data.id); });

    cell.append("clipPath")
        .attr("id", function(d) { return "clip-" + d.data.id; })
      .append("use")
        .attr("xlink:href", function(d) { return "#" + d.data.id; });

    cell.append("text")
        .attr("clip-path", function(d) { return "url(#clip-" + d.data.id + ")"; })
      .selectAll("tspan")
        .data(function(d) { return d.data.name.split(/(?=[A-Z][^A-Z])/g); })
      .enter().append("tspan")
        .attr("x", 4)
        .attr("y", function(d, i) { return 13 + i * 10; })
        .text(function(d) { return d; });

    cell.append("title")
        .text(function(d) { return d.data.id+ "\n" + format(d.value); });
    // };

    // function changed(roots) {
    //   document.querySelector("svg").innerHTML = "";
    //   treemap(roots);
    //   makeTreemap(roots);   
    // }

  // Change/Transition Function
    function changed(roots) {
      treemap(roots);
      // document.querySelector("svg").innerHTML = "";
      console.log(roots);

      cell.transition()
          .duration(750)
          .attr("transform", function(d) { return "translate(" + d.x0 + "," + d.y0 + ")"; })
        .select("rect")
          .attr("width", function(d) { return d.x1 - d.x0; })
          .attr("height", function(d) { return d.y1 - d.y0; });
    }
  });
  </script>

</body>