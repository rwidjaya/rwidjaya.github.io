<!DOCTYPE html>
<head>
  <style>

  form {
    font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  }

  svg {
    font: 10px sans-serif;
  }

  </style>
</head>

<body>
  <div class="container">
    <div id="slider"></div>
    <div id="chart">
      <svg width="960" height="570"></svg>
    </div>
  </div>
  <!-- <form>
  <label><input type="radio" name="mode" value="sumBySize" checked> Size</label>
   <label><input type="radio" name="mode" value="sumByCount"> Count</label>
   </form> -->
  <script type="text/javascript" src="d3.js"></script>
  <script>

  var headline = "Number of H1-B Certifications in";
  var init_year = 2011;

  var svg = d3.select("svg"),
      width = +svg.attr("width"),
      height = +svg.attr("height");

  var state_size = function(color) { return d3.interpolateRgb(color, "#fff")(0.2); },
      color = d3.scaleOrdinal(d3.schemeCategory20.map(state_size)),
      format = d3.format(",d");

  var treemap = d3.treemap()
      .tile(d3.treemapResquarify)
      .size([width, height])
      .round(true)
      .paddingInner(1);

  d3.select("#slider").insert("p", ":first-child").append("input")
      .attr("type", "range")
      .attr("min", "2011")
      .attr("max", "2016")
      .attr("value", init_year)
      .attr("id", "sliderControl");

  d3.select("#slider").insert("h2", ":first-child").text(headline + " " + init_year);


  // Reading Data
  d3.json("state_size.json", function(error, data) {
    if (error) throw error;

    var root = d3.hierarchy(data[0])
        .eachBefore(function(d) { d.data.id = (d.parent ? d.parent.data.id + "." : "") + d.data.name; })
        .sum(sumBySize)
        .sort(function(a, b) { return b.height - a.height || b.value - a.value; });

    treemap(root);

    var cell = svg.selectAll("g")
      .data(root.leaves())
      .enter().append("g")
        .attr("transform", function(d) { return "translate(" + d.x0 + "," + d.y0 + ")"; });


    cell.append("rect")
        .attr("id", function(d) { return d.data.name; })
        .attr("width", function(d) { return d.x1 - d.x0; })
        .attr("height", function(d) { return d.y1 - d.y0; })
        .attr("fill", function(d) { return color(d.data.name); });

    cell.append("clipPath")
        .attr("id", function(d) { return "clip-" + d.data.name; })
      .append("use")
        .attr("xlink:href", function(d) { return "#" + d.data.name; });

    cell.append("text")
        .attr("clip-path", function(d) { return "url(#clip-" + d.data.name + ")"; })
      .selectAll("tspan")
        .data(function(d) { return d.data.name; })
      .enter().append("tspan")
        .attr("x", 4)
        .attr("y", function(d, i) { return 13 + i * 10; })
        .text(function(d) { return d; });

    cell.append("title")
        .text(function(d) { return d.data.name + "\n" + format(d.value); });


    // d3.selectAll("input")
    //     .data([sumBySize, sumByCount], function(d) { return d ? d.name : this.value; })
    //     .on("change", changed);

    d3.select("#sliderControl").on("input", function() {
        var index = this.value - 2011;
        var currentData = data[index];

        newRoots = d3.hierarchy(currentData)
        .eachBefore(function(d) { d.data.id = (d.parent ? d.parent.data.id + "." : "") + d.data.name; })
        .sum(sumBySize)
        .sort(function(a, b) { return b.height - a.height || b.value - a.value; });

        changed(newRoots);

    });

    // var timeout = d3.timeout(function() {
    //   d3.select("input[value=\"sumByCount\"]")
    //       .property("checked", true)
    //       .dispatch("change");
    // }, 2000);

    function changed(roots) {
      // timeout.stop();

      treemap(roots.sum(sumBySize));

      cell.transition()
          .duration(750)
          .attr("transform", function(d) { return "translate(" + d.x0 + "," + d.y0 + ")"; })
        .select("rect")
          .attr("width", function(d) { return d.x1 - d.x0; })
          .attr("height", function(d) { return d.y1 - d.y0; });
    }
  });

  // function sumByCount(d) {
  //   return d.state ? 0 : 1;
  // }

  function sumBySize(d) {
    return d.size;
  }

  </script>
</body>